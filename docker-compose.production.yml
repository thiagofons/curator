services:
  # >>> Blog CMS (Payload + Next.js) <<<
  blog-cms:
    build:
      context: ./apps/frontend/blog-cms
      dockerfile: Dockerfile
    env_file:
      - .env.production
    environment:
      DATABASE_URI: ${DATABASE_URI}
      PAYLOAD_SECRET: ${PAYLOAD_SECRET}
    ports:
      - "4001:3000"
    depends_on:
      - redis
      - rabbitmq
    networks:
      - curator-net
    volumes:
      - blog_cms_media:/app/media

  # >>> Redis Cache <<<
  redis:
    image: redis:7-alpine
    env_file:
      - .env.production
    ports:
      - "${REDIS_EXTERNAL_PORT}:6379"
    volumes:
      - redis_data:/data
    networks:
      - curator-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # >>> RabbitMQ Message Broker <<<
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    env_file:
      - .env.production
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "5672:5672"
      - "${RMQ_MANAGEMENT_EXTERNAL_PORT}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - curator-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

# >>> Named Volumes <<<
volumes:
  blog_cms_media:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local

# >>> Custom Network <<<
networks:
  curator-net:
    driver: bridge

