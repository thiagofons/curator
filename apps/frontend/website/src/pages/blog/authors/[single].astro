---
import AuthorSingle from "@/components/blog/AuthorSingle.astro";
import Base from "@/layouts/Base.astro";
import { getPayloadAuthors, getPayloadPostsByAuthorSlug } from "@/lib/payload";

export async function getStaticPaths() {
  const authors = await getPayloadAuthors();

  return authors
    .filter((author) => Boolean(author?.slug))
    .map((author) => ({
      params: {
        single: author.slug,
      },
    }));
}

type Props = {
  author?: any;
  isPayload?: boolean;
  contentHtml?: string;
};

const slug = Astro.params.single;

const initialProps = Astro.props as Props;

let author = initialProps.author;
let isPayload = initialProps.isPayload ?? true;
let contentHtml = initialProps.contentHtml;

// Resolve autor pelo slug (fallback quando nÃ£o vier via props)
if (!author?.slug || author.slug !== slug) {
  try {
    const authors = await getPayloadAuthors();
    author = authors.find((a) => a?.slug === slug);
    contentHtml = author?.contentHtml;
  } catch (error) {
    console.error(`Failed to fetch author by slug "${slug}":`, error);
  }
}

if (!author?.slug) {
  return Astro.redirect("/blog");
}

const { title, image } = author.data ?? {};
const posts = await getPayloadPostsByAuthorSlug(author.slug);
---

<Base title={title || "Autor"} theme="dark">
  <AuthorSingle
    author={author}
    posts={posts}
    isPayload={isPayload}
    contentHtml={contentHtml}
  />
</Base>
