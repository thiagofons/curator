# More generic name, as it now does more than just "quality"
name: "Main CI"

on:
  push:
    branches:
      - main
      - develop
  pull_request:

# Cancel previous jobs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------------------------------
  # JOB 1: Static Quality (Fast, no dependencies)
  # -----------------------------------------------------------------
  quality:
    name: "ğŸ¨ Quality (Format + Lint)"
    runs-on: ubuntu-latest
    steps:
      - name: "[Clone] Checkout"
        uses: actions/checkout@v4

      - name: "[Setup] pnpm"
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: "[Setup] Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22" # Use your .nvmrc version
          cache: "pnpm"

      - name: "[âš™ï¸ Setup] Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "[ğŸ¨ Quality] Check Format (Prettier)"
        # This script should now run Prettier
        run: pnpm quality:format:check

      - name: "[ğŸ¨ Quality] Check Lint (ESLint)"
        # This script should now run ESLint
        run: pnpm quality:lint:check

  # -----------------------------------------------------------------
  # JOB 2: Unit Tests (Fast, no dependencies)
  # -----------------------------------------------------------------
  test-unit:
    name: "ğŸ§ª Unit Tests"
    runs-on: ubuntu-latest
    steps:
      - name: "[âš™ï¸ Setup] Checkout"
        uses: actions/checkout@v4

      - name: "[âš™ï¸ Setup] pnpm"
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: "[âš™ï¸ Setup] Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: "[âš™ï¸ Setup] Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "[ğŸ§ª Tests] Run Unit Tests (>80% coverage)"
        run: pnpm test:unit:coverage

  # -----------------------------------------------------------------
  # JOB 3: Integration Tests (Slow, WITH database)
  # -----------------------------------------------------------------
  test-integration:
    name: "ğŸ§ª Integration Tests (w/ DB)"
    runs-on: ubuntu-latest

    # Starts a PostgreSQL container for this job
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: curator_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: "[âš™ï¸ Setup] Checkout"
        uses: actions/checkout@v4

      - name: "[âš™ï¸ Setup] pnpm"
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: "[âš™ï¸ Setup] Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: "[âš™ï¸ Setup] Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: "[ğŸ§ª Tests] Run Integration Tests"
        # Set the DATABASE_URL so that Prisma (in global-setup)
        # can find the 'services' database on localhost
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/curator_test"
        # CORRECTED: Runs the integration script, not the unit script
        run: pnpm test:integration
