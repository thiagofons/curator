name: ğŸ¤– CI - Pull Request Validation

on:
  push:
    branches: [main, develop]
  pull_request:

permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # 1. STATIC CHECKS (Lint & Format)
  # ------------------------------------------------------------------
  static-checks:
    name: ğŸ¨ Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âœ¨ Check Formatting
        run: pnpm quality:format:check

      - name: ğŸš¨ Check Linting
        run: pnpm quality:lint:check

  # ------------------------------------------------------------------
  # 2. UNIT TESTS (Generates Coverage Artifacts)
  # ------------------------------------------------------------------
  unit-tests:
    name: ğŸ§ª Unit Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run Unit Tests (with Coverage)
        run: pnpm test:unit:coverage

      # Uploads coverage reports to be consumed by the Sonar job
      - name: ğŸ“¤ Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/backend/**/coverage/lcov.info
            apps/backend/**/test-report.xml
            packages/**/coverage/lcov.info
            packages/**/test-report.xml
          retention-days: 1

  # ------------------------------------------------------------------
  # 3. INTEGRATION TESTS
  # ------------------------------------------------------------------
  integration-tests:
    name: âš™ï¸ Integration Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: curator_test
        ports: [5432:5432]
        options: >-
          --health-cmd "pg_isready" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âš™ï¸ Run Integration Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/curator_test
        run: pnpm test:integration

  # ------------------------------------------------------------------
  # 4. SONARQUBE ANALYSIS (Matrix Strategy)
  # ------------------------------------------------------------------
  sonar-analysis:
    name: ğŸ” Sonar (${{ matrix.service }})
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- BACKEND SERVICES ---
          - service: backend/api-gateway
            path: apps/backend/api-gateway

          - service: backend/authentication-service
            path: apps/backend/authentication-service

          - service: backend/identity-service
            path: apps/backend/identity-service

          # --- FRONTEND SERVICES ---
          - service: frontend/blog-cms
            path: apps/frontend/blog-cms

          - service: frontend/docs
            path: apps/frontend/docs

          - service: frontend/website
            path: apps/frontend/website

          # --- PACKAGES ---
          - service: packages/lib
            path: packages/lib

          - service: packages/rabbitmq
            path: packages/rabbitmq

          - service: packages/trpc
            path: packages/trpc

          - service: packages/ui-mobile
            path: packages/ui-mobile

          - service: packages/ui-web
            path: packages/ui-web

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Sonar "New Code" detection

      - name: ğŸ“¥ Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: .

      - name: ğŸ” SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        with:
          projectBaseDir: ${{ matrix.path }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_GLOBAL }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # -----------------------------------------------------------------
  # 5. SNYK DEPENDENCY SCAN
  # -----------------------------------------------------------------
  snyk-scan:
    name: ğŸ•µï¸ Snyk Vulnerability Scan
    needs: [sonar-analysis]
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ›¡ï¸ Run Snyk (Dependencies)
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --all-projects --severity-threshold=high

  # -----------------------------------------------------------------
  # 6. BUILD DOCKER IMAGES
  # -----------------------------------------------------------------
  build-docker-images:
    name: ğŸ³ Build Images (Local)
    needs:
      [static-checks, unit-tests, integration-tests, sonar-analysis, snyk-scan]
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: "â¬‡ï¸ Checkout Repo"
        uses: actions/checkout@v4

      - name: "ğŸ•µï¸ Detect Changes"
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api_gateway:
              - 'apps/backend/api-gateway/**'
              - 'packages/**'
              - 'docker-compose.yml'
            auth_service:
              - 'apps/backend/authentication-service/**'
              - 'packages/**'
            identity_service:
              - 'apps/backend/identity-service/**'
              - 'packages/**'
            blog_cms:
              - 'apps/frontend/blog-cms/**'
              - 'packages/**'

      - name: "ğŸ³ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ğŸ—ï¸ Build API Gateway"
        if: steps.filter.outputs.api_gateway == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/api-gateway/Dockerfile
          push: false
          tags: curator/api-gateway:pr-${{ github.sha }}
          outputs: type=docker,dest=/tmp/api-gateway.tar

      - name: "ğŸ—ï¸ Build Identity Service"
        if: steps.filter.outputs.identity_service == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/identity-service/Dockerfile
          push: false
          tags: curator/identity-service:pr-${{ github.sha }}
          outputs: type=docker,dest=/tmp/identity-service.tar

      - name: "ğŸ—ï¸ Build Authentication Service"
        if: steps.filter.outputs.auth_service == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/authentication-service/Dockerfile
          push: false
          tags: curator/authentication-service:pr-${{ github.sha }}
          outputs: type=docker,dest=/tmp/authentication-service.tar

      - name: "ğŸ—ï¸ Build Blog CMS"
        if: steps.filter.outputs.blog_cms == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/frontend/blog-cms/Dockerfile
          push: false
          tags: curator/blog-cms:pr-${{ github.sha }}
          outputs: type=docker,dest=/tmp/blog-cms.tar

      - name: "ğŸ“¤ Upload Docker Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-tar
          path: /tmp/*.tar
          retention-days: 1
