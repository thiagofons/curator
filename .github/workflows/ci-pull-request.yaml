name: ğŸ¤– CI - Pull Request Validation

on:
  push:
    branches: [main, develop]
  pull_request:

permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # 1. STATIC CHECKS (Lint & Format)
  # ------------------------------------------------------------------
  static-checks:
    name: ğŸ¨ Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âœ¨ Check Formatting
        run: pnpm quality:format:check

      - name: ğŸš¨ Check Linting
        run: pnpm quality:lint:check

  # ------------------------------------------------------------------
  # 2. UNIT TESTS (Generates Coverage Artifacts)
  # ------------------------------------------------------------------
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run Unit Tests (with Coverage)
        run: pnpm test:unit:coverage

      # Uploads coverage reports to be consumed by the Sonar job
      - name: ğŸ“¤ Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/backend/**/coverage/lcov.info
            apps/backend/**/test-report.xml
            packages/**/coverage/lcov.info
            packages/**/test-report.xml
          retention-days: 1

  # ------------------------------------------------------------------
  # 3. INTEGRATION TESTS
  # ------------------------------------------------------------------
  integration-tests:
    name: âš™ï¸ Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: curator_test
        ports: [5432:5432]
        options: >-
          --health-cmd "pg_isready" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âš™ï¸ Run Integration Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/curator_test
        run: pnpm test:integration

  # ------------------------------------------------------------------
  # 4. SONARQUBE ANALYSIS (Matrix Strategy)
  # ------------------------------------------------------------------
  sonar-analysis:
    name: ğŸ” Sonar (${{ matrix.service }})
    needs: [unit-tests] # Waits for coverage artifacts
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- SERVICE LIST ---
          - service: identity-service
            path: apps/backend/identity-service

          - service: roadmap-service
            path: apps/backend/roadmap-service

          - service: api-gateway
            path: apps/backend/api-gateway

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Sonar "New Code" detection

      - name: ğŸ“¥ Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: .

      - name: ğŸ” SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        with:
          projectBaseDir: ${{ matrix.path }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_GLOBAL }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
