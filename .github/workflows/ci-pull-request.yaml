name: ğŸ¤– CI - Pull Request Validation

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # 0. SECRET SCANNING (Pre-check â€” runs in parallel with static-checks)
  # ------------------------------------------------------------------
  secret-scan:
    name: ğŸ•µï¸ Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: ğŸ•µï¸ Run Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------------
  # 1. STATIC CHECKS (Gatekeeper)
  # ------------------------------------------------------------------
  static-checks:
    name: ğŸ¨ Lint & Format
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # NecessÃ¡rio para o --affected comparar branches

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âœ¨ Check Formatting
        run: pnpm turbo run quality:format:check --affected

      - name: ğŸš¨ Check Linting
        run: pnpm turbo run lint --affected

  # ------------------------------------------------------------------
  # 2. UNIT TESTS (Parallel)
  # ------------------------------------------------------------------
  unit-tests:
    name: ğŸ§ª Unit Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run Unit Tests (with Coverage)
        run: pnpm turbo run test:unit:coverage --affected

      - name: ğŸ“¤ Upload Test Artifacts
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: coverage-reports
          path: |
            apps/backend/**/coverage/lcov.info
            apps/backend/**/test-report.xml
            packages/**/coverage/lcov.info
            packages/**/test-report.xml
          retention-days: 1
          if-no-files-found: ignore

  # ------------------------------------------------------------------
  # 3. INTEGRATION TESTS (Parallel)
  # ------------------------------------------------------------------
  integration-tests:
    name: âš™ï¸ Integration Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: curator_test
        ports: [5432:5432]
        options: >-
          --health-cmd "pg_isready" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âš™ï¸ Run Integration Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/curator_test
        run: pnpm turbo run test:integration --affected

  # ------------------------------------------------------------------
  # 4. SONARQUBE ANALYSIS (Matrix Strategy)
  # ------------------------------------------------------------------
  sonar-analysis:
    name: ğŸ” Sonar (${{ matrix.service }})
    needs: [unit-tests]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- BACKEND ---
          - service: backend/api
            path: apps/backend/api
          - service: backend/cms
            path: apps/backend/cms

          # --- FRONTEND ---
          - service: frontend/docs
            path: apps/frontend/docs
          - service: frontend/website
            path: apps/frontend/website

          # --- PACKAGES ---
          - service: packages/lib
            path: packages/lib
          - service: packages/rabbitmq
            path: packages/rabbitmq
          - service: packages/trpc
            path: packages/trpc
          - service: packages/ui-mobile
            path: packages/ui-mobile
          - service: packages/ui-web
            path: packages/ui-web

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download Coverage Reports
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        continue-on-error: true
        with:
          name: coverage-reports
          path: .

      - name: ğŸ” Check if coverage exists for this service
        id: check_coverage
        run: |
          if [ -f "${{ matrix.path }}/coverage/lcov.info" ] || [ -f "${{ matrix.path }}/test-report.xml" ]; then
            echo "has_coverage=true" >> $GITHUB_OUTPUT
          else
            echo "has_coverage=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” SonarQube Scan
        if: steps.check_coverage.outputs.has_coverage == 'true'
        uses: sonarsource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        with:
          projectBaseDir: ${{ matrix.path }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_GLOBAL }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: ğŸš¦ SonarQube Quality Gate
        if: steps.check_coverage.outputs.has_coverage == 'true'
        uses: sonarsource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b # v1.2.0
        timeout-minutes: 5
        with:
          scanMetadataReportFile: ${{ matrix.path }}/.scannerwork/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_GLOBAL }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # ------------------------------------------------------------------
  # 5. E2E TESTS (Only on push to main â€” final gate before CD)
  # ------------------------------------------------------------------
  e2e-tests:
    name: ğŸ­ E2E Tests
    needs: [unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ­ Run E2E Tests
        run: pnpm test:e2e
