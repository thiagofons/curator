name: ğŸ¤– CI - Pull Request Validation

on:
  push:
    branches: [main, develop]
  pull_request:

permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # 1. STATIC CHECKS (Gatekeeper)
  # ------------------------------------------------------------------
  static-checks:
    name: ğŸ¨ Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âœ¨ Check Formatting
        run: pnpm quality:format:check

      - name: ğŸš¨ Check Linting
        run: pnpm quality:lint:check

  # ------------------------------------------------------------------
  # 2. UNIT TESTS (Parallel)
  # ------------------------------------------------------------------
  unit-tests:
    name: ğŸ§ª Unit Tests
    needs: [static-checks] # Dependency: Fail Fast
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run Unit Tests (with Coverage)
        run: pnpm test:unit:coverage

      # Upload artifacts for the Sonar Job
      - name: ğŸ“¤ Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/backend/**/coverage/lcov.info
            apps/backend/**/test-report.xml
            packages/**/coverage/lcov.info
            packages/**/test-report.xml
          retention-days: 1

  # ------------------------------------------------------------------
  # 3. INTEGRATION TESTS (Parallel)
  # ------------------------------------------------------------------
  integration-tests:
    name: âš™ï¸ Integration Tests
    needs: [static-checks] # Dependency: Fail Fast
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: curator_test
        ports: [5432:5432]
        options: >-
          --health-cmd "pg_isready" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âš™ï¸ Run Integration Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/curator_test
        run: pnpm test:integration

  # ------------------------------------------------------------------
  # 4. SNYK SCAN (Parallel)
  # ------------------------------------------------------------------
  snyk-scan:
    name: ğŸ•µï¸ Snyk Vulnerability Scan
    needs: [static-checks] # Dependency: Fail Fast
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ›¡ï¸ Run Snyk (Dependencies)
        continue-on-error: true
        uses: snyk/actions/node@0.4.0
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --all-projects --severity-threshold=high

  # ------------------------------------------------------------------
  # 5. SONARQUBE ANALYSIS (Parallel / Dependent on Artifacts)
  # ------------------------------------------------------------------
  sonar-analysis:
    name: ğŸ” Sonar (${{ matrix.service }})
    needs: [unit-tests] # Needs coverage artifacts from Unit Tests
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- BACKEND ---
          - service: backend/api-gateway
            path: apps/backend/api-gateway
          - service: backend/authentication-service
            path: apps/backend/authentication-service
          - service: backend/identity-service
            path: apps/backend/identity-service

          # --- FRONTEND ---
          - service: frontend/blog-cms
            path: apps/frontend/blog-cms
          - service: frontend/docs
            path: apps/frontend/docs
          - service: frontend/website
            path: apps/frontend/website

          # --- PACKAGES ---
          - service: packages/lib
            path: packages/lib
          - service: packages/rabbitmq
            path: packages/rabbitmq
          - service: packages/trpc
            path: packages/trpc
          - service: packages/ui-mobile
            path: packages/ui-mobile
          - service: packages/ui-web
            path: packages/ui-web

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: .

      - name: ğŸ” SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        with:
          projectBaseDir: ${{ matrix.path }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_GLOBAL }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # -----------------------------------------------------------------
  # 6. BUILD DOCKER IMAGES
  # -----------------------------------------------------------------
  build-docker-images:
    name: ğŸ³ Build Images
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: "â¬‡ï¸ Checkout Repo"
        uses: actions/checkout@v4

      - name: "ğŸ•µï¸ Detect Changes"
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api_gateway:
              - 'apps/backend/api-gateway/**'
              - 'packages/**'
              - 'docker-compose.yaml'
            auth_service:
              - 'apps/backend/authentication-service/**'
              - 'packages/**'
              - 'docker-compose.yaml'
            identity_service:
              - 'apps/backend/identity-service/**'
              - 'packages/**'
              - 'docker-compose.yaml'
            blog_cms:
              - 'apps/frontend/blog-cms/**'
              - 'packages/**'
              - 'docker-compose.yaml'

      - name: "ğŸ³ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ğŸ“ Make Temp Dir"
        run: mkdir -p /tmp/images

      - name: "ğŸ—ï¸ Build API Gateway"
        if: steps.filter.outputs.api_gateway == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/api-gateway/Dockerfile
          push: false
          tags: curator/api-gateway:${{ github.sha }}
          outputs: type=docker,dest=/tmp/images/api-gateway.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "ğŸ—ï¸ Build Identity Service"
        if: steps.filter.outputs.identity_service == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/identity-service/Dockerfile
          push: false
          tags: curator/identity-service:${{ github.sha }}
          outputs: type=docker,dest=/tmp/images/identity-service.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "ğŸ—ï¸ Build Authentication Service"
        if: steps.filter.outputs.auth_service == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend/authentication-service/Dockerfile
          push: false
          tags: curator/authentication-service:${{ github.sha }}
          outputs: type=docker,dest=/tmp/images/authentication-service.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "ğŸ—ï¸ Build Blog CMS"
        if: steps.filter.outputs.blog_cms == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/frontend/blog-cms/Dockerfile
          push: false
          tags: curator/blog-cms:${{ github.sha }}
          outputs: type=docker,dest=/tmp/images/blog-cms.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "ğŸ“ Create Placeholder"
        run: touch /tmp/images/.placeholder

      - name: "ğŸ“¤ Upload Image Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: built-images
          path: |
            /tmp/images/*.tar
            /tmp/images/.placeholder
          retention-days: 1
          if-no-files-found: error

  # -----------------------------------------------------------------
  # 7. SCAN DOCKER IMAGES (Trivy)
  #    Analisa os arquivos .tar gerados procurando vulnerabilidades
  # -----------------------------------------------------------------
  scan-images:
    name: ğŸ›¡ï¸ Scan Images (Trivy)
    needs: [build-docker-images]
    runs-on: ubuntu-latest
    permissions:
      security-events: write # NecessÃ¡rio se quiser upload pro GitHub Security (opcional)

    steps:
      - name: "â¬‡ï¸ Checkout Repo"
        uses: actions/checkout@v4

      - name: "ğŸ“¥ Download Images"
        uses: actions/download-artifact@v4
        with:
          name: built-images
          path: /tmp/images

      # 1. API GATEWAY
      - name: "ğŸ” Scan API Gateway"
        if: hashFiles('/tmp/images/api-gateway.tar') != ''
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/images/api-gateway.tar
          format: "table" # Mostra tabela bonita no log
          exit-code: "1" # Quebra o build se achar falhas
          ignore-unfixed: true # Ignora CVEs que nÃ£o tÃªm correÃ§Ã£o (Reduz ruÃ­do)
          vuln-type: "os,library" # Analisa OS (Alpine) e Libs (Node_modules)
          severity: "CRITICAL,HIGH"

      # 2. IDENTITY SERVICE
      - name: "ğŸ” Scan Identity Service"
        if: hashFiles('/tmp/images/identity-service.tar') != ''
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/images/identity-service.tar
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      # 3. AUTHENTICATION SERVICE
      - name: "ğŸ” Scan Auth Service"
        if: hashFiles('/tmp/images/authentication-service.tar') != ''
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/images/authentication-service.tar
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      # 4. BLOG CMS
      - name: "ğŸ” Scan Blog CMS"
        if: hashFiles('/tmp/images/blog-cms.tar') != ''
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/images/blog-cms.tar
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
