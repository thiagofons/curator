name: ü§ñ CI - Pull Request Validation

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # 1. STATIC CHECKS (Gatekeeper)
  # ------------------------------------------------------------------
  static-checks:
    name: üé® Lint & Format
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necess√°rio para o --affected comparar branches

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: üì• Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ‚ú® Check Formatting
        run: pnpm turbo run quality:format:check --affected

      - name: üö® Check Linting
        run: pnpm turbo run lint --affected

  # ------------------------------------------------------------------
  # 2. UNIT TESTS (Parallel)
  # ------------------------------------------------------------------
  unit-tests:
    name: üß™ Unit Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: üì• Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: üß™ Run Unit Tests (with Coverage)
        run: pnpm turbo run test:unit:coverage --affected

      - name: üì§ Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/backend/**/coverage/lcov.info
            apps/backend/**/test-report.xml
            packages/**/coverage/lcov.info
            packages/**/test-report.xml
          retention-days: 1

  # ------------------------------------------------------------------
  # 3. INTEGRATION TESTS (Parallel)
  # ------------------------------------------------------------------
  integration-tests:
    name: ‚öôÔ∏è Integration Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: curator_test
        ports: [5432:5432]
        options: >-
          --health-cmd "pg_isready" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.5.0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: üì• Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ‚öôÔ∏è Run Integration Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/curator_test
        run: pnpm turbo run test:integration --affected

  # ------------------------------------------------------------------
  # 4. SONARQUBE ANALYSIS (Matrix Strategy)
  # ------------------------------------------------------------------
  sonar-analysis:
    name: üîç Sonar (${{ matrix.service }})
    needs: [unit-tests]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- BACKEND ---
          - service: backend/api
            path: apps/backend/api
          - service: backend/cms
            path: apps/backend/cms

          # --- FRONTEND ---
          - service: frontend/docs
            path: apps/frontend/docs
          - service: frontend/website
            path: apps/frontend/website

          # --- PACKAGES ---
          - service: packages/lib
            path: packages/lib
          - service: packages/rabbitmq
            path: packages/rabbitmq
          - service: packages/trpc
            path: packages/trpc
          - service: packages/ui-mobile
            path: packages/ui-mobile
          - service: packages/ui-web
            path: packages/ui-web

    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì• Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: .

      - name: üîç SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v4
        with:
          projectBaseDir: ${{ matrix.path }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_GLOBAL }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
